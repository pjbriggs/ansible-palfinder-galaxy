---
# Create user accounts in Galaxy instance

- name: "Set Galaxy URL"
  set_fact:
    galaxy_url: "{{ 'https' if enable_https else 'http' }}://{{ galaxy_server_name }}{{ galaxy_proxy_prefix }}/"

- name: "Create and activate Galaxy user accounts"
  block:
    # Create the accounts
    - name: "Add master API key to Galaxy config for tool installation"
      lineinfile:
        path: "{{ galaxy_root }}/config/galaxy.yml"
        search_string: "#master_api_key:"
        line: "  master_api_key: {{ master_api_key }}"
        state: present

    - name: "Restart Galaxy service with master API key enabled"
      service:
        name: "galaxy"
        state: restarted

    - name: "Create Galaxy user accounts"
      command:
        "{{ galaxy_utils_dir }}/bin/create_user.sh '{{ item.email }}' '{{ item.password }}' '{{ master_api_key }}' '{{ galaxy_url }}'"
      with_items: "{{ galaxy_users }}"

    - name: "Remove master API key from Galaxy configuration"
      lineinfile:
        path: "{{ galaxy_root }}/config/galaxy.yml"
        search_string: "master_api_key:"
        line: "  #master_api_key: changethis"
        state: present

    - name: "Restart Galaxy service with master API key disabled"
      service:
        name: "galaxy"
        state: restarted

    # Activate accounts
    - name: "Activate Galaxy user accounts"
      command:
        "{{ galaxy_utils_dir }}/bin/activate_user.sh '{{ galaxy_db }}' '{{ galaxy_db_user }}' '{{ galaxy_db_password }}' '{{ item.email }}'"
      with_items: "{{ galaxy_users }}"
      become: yes
      become_user: "{{ galaxy_user }}"
      when: enable_user_activation
  when: galaxy_users|default(None) != None

